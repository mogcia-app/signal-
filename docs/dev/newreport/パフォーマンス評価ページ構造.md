# パフォーマンス評価ページ構造

## ページ構成

### `/instagram/report` - パフォーマンス評価ページ

**URL**: `/instagram/report`  
**説明**: 月次のパフォーマンス評価スコア（A〜F評価）を表示するページ

---

## ファイル構造

```
src/app/instagram/report/
├── page.tsx                          # メインページ
└── components/
    ├── ReportHeader.tsx               # ヘッダー（月選択）
    └── PerformanceScore.tsx           # パフォーマンス評価表示コンポーネント

src/app/api/analytics/performance-score/
└── route.ts                           # パフォーマンス評価API
```

---

## コンポーネント詳細

### 1. `page.tsx` - メインページ

**責務**:
- ページのレイアウト管理
- パフォーマンス評価スコアの取得と状態管理
- エラーハンドリング

**状態管理**:
- `selectedMonth`: 選択された月（YYYY-MM形式）
- `performanceScore`: パフォーマンス評価スコアデータ
- `isLoading`: ローディング状態
- `error`: エラー状態

**データ取得**:
- `fetchPerformanceScore`: `/api/analytics/performance-score?date=YYYY-MM` を呼び出し

**レイアウト**:
- `SNSLayout` を使用（サイドバーが含まれる）
- レスポンシブ対応（`p-4 sm:p-6`）

---

### 2. `ReportHeader.tsx` - ヘッダーコンポーネント

**責務**:
- ページタイトル表示
- 月選択機能

**Props**:
```typescript
interface ReportHeaderProps {
  selectedMonth: string;
  onMonthChange: (month: string) => void;
  getMonthDisplayName: (monthStr: string) => string;
}
```

**機能**:
- 月選択（`<input type="month">`）
- 月の表示名を日本語で表示（例: "2025年11月"）

**レスポンシブ対応**:
- モバイル: 縦並び（`flex-col`）
- デスクトップ: 横並び（`lg:flex-row`）
- アイコンサイズ、タイトルサイズもレスポンシブ

---

### 3. `PerformanceScore.tsx` - パフォーマンス評価表示コンポーネント

**責務**:
- パフォーマンス評価スコア（A〜F）の表示
- スコア内訳の表示
- KPIの表示
- メトリクスの表示

**Props**:
```typescript
interface PerformanceScoreProps {
  score: number;                    // 総合スコア（0-100）
  rating: "S" | "A" | "B" | "C" | "D" | "F";
  label: string;                    // 評価ラベル（例: "優秀なクリエイター"）
  color: string;                    // カラー（purple, blue, green, yellow, orange, red）
  breakdown: {
    engagement: number;             // エンゲージメントスコア（0-50）
    growth: number;                 // 成長スコア（0-25）
    quality: number;                // 品質スコア（0-15）
    consistency: number;            // 一貫性スコア（0-10）
  };
  kpis: {
    totalLikes: number;             // 総いいね数
    totalReach: number;              // 総リーチ数
    totalSaves: number;              // 総保存数
    totalComments: number;           // 総コメント数
  };
  metrics: {
    postCount: number;               // 投稿数
    analyzedCount: number;           // 分析済み数
    hasPlan: boolean;                // 計画の有無
  };
  isLoading?: boolean;               // ローディング状態
}
```

**表示内容**:
1. **評価バッジ**: 大きな円形バッジに評価（S, A, B, C, D, F）を表示
2. **スコア内訳**: 4つのスコア（エンゲージメント、成長、品質、一貫性）をグリッド表示
3. **KPIカード**: いいね、リーチ、保存、コメント数をカラフルなカードで表示
4. **メトリクス**: 投稿数、分析済み数、運用計画の有無を表示

**レスポンシブ対応**:
- グリッドレイアウトがモバイル（2列）とデスクトップ（4列）で切り替わる
- パディング、フォントサイズもレスポンシブ

---

## API詳細

### `GET /api/analytics/performance-score`

**パラメータ**:
- `date` (必須): `YYYY-MM` 形式（例: `"2025-11"`）

**レスポンス**:
```typescript
{
  success: true,
  data: {
    score: number;                    // 総合スコア（0-100）
    rating: "S" | "A" | "B" | "C" | "D" | "F";
    label: string;
    color: string;
    breakdown: {
      engagement: number;
      growth: number;
      quality: number;
      consistency: number;
    };
    kpis: {
      totalLikes: number;
      totalReach: number;
      totalSaves: number;
      totalComments: number;
    };
    metrics: {
      postCount: number;
      analyzedCount: number;
      hasPlan: boolean;
    };
  }
}
```

**使用コレクション**:
1. `analytics` - 期間内の分析データ（KPI計算用）
2. `posts` - 期間内の投稿数
3. `plans` - 計画の有無確認

**クエリ詳細**:
```typescript
// 1. 期間内の投稿を取得
adminDb
  .collection("posts")
  .where("userId", "==", uid)
  .where("createdAt", ">=", startTimestamp)
  .where("createdAt", "<=", endTimestamp)
  .get()

// 2. 期間内の分析データを取得（クエリで期間フィルタリング）
adminDb
  .collection("analytics")
  .where("userId", "==", uid)
  .where("publishedAt", ">=", startTimestamp)
  .where("publishedAt", "<=", endTimestamp)
  .get()

// 3. 計画の有無確認
adminDb
  .collection("plans")
  .where("userId", "==", uid)
  .where("snsType", "==", "instagram")
  .where("status", "==", "active")
  .limit(1)
  .get()
```

**データ整合性の処理**:
1. **投稿と分析データの紐付け**: 期間内の投稿ID（`postIdsInPeriod`）を使用して、対応する分析データのみを抽出
2. **重複データの処理**: 同じ`postId`に複数の分析データがある場合、`publishedAt`が最新のものを採用
3. **型統一**: `publishedAt`を`Date`型に統一（`Timestamp` → `Date`変換）して、比較演算を安全に実行

**必要なインデックス**:
```json
// analytics コレクション
{
  "collectionGroup": "analytics",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "publishedAt", "order": "ASCENDING" }
  ]
}

// posts コレクション
{
  "collectionGroup": "posts",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "createdAt", "order": "ASCENDING" }
  ]
}

// plans コレクション
{
  "collectionGroup": "plans",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "snsType", "order": "ASCENDING" },
    { "fieldPath": "status", "order": "ASCENDING" }
  ]
}
```

**計算ロジック**:
1. **エンゲージメントスコア (最大50点)**: 
   - 平均エンゲージメント率 = Σ((いいね + コメント + シェア) / リーチ × 100) / 分析済み投稿数
   - スコア = 平均エンゲージメント率 × 10（最大50点に制限）
2. **成長スコア (最大25点)**: 
   - 総フォロワー増加数 = Σ(各投稿のフォロワー増加数)
   - スコア = 総フォロワー増加数 × 0.05（最大25点に制限）
3. **品質スコア (最大15点)**: 
   - 平均リーチ数 = 総リーチ数 / 分析済み投稿数
   - スコア = 平均リーチ数 / 2000（最大15点に制限）
4. **一貫性スコア (最大10点)**: 
   - 週間投稿数 = 月間投稿数 / 4（月を4週として計算）
   - スコア = 週間投稿数 × 3.33（最大10点に制限）

**総合スコア**: 4つのスコアの合計（最大100点）

**ランク評価**:
- S: 85点以上（業界トップ0.1%）
- A: 70点以上（優秀なクリエイター）
- B: 55点以上（良好）
- C: 40点以上（平均）
- D: 25点以上（改善必要）
- F: 25点未満（大幅改善必要）

---

## データフロー

```
ページロード
  ↓
認証確認
  ↓
selectedMonth が設定される
  ↓
fetchPerformanceScore(selectedMonth)
  ↓
GET /api/analytics/performance-score?date=YYYY-MM
  ↓
月の範囲を計算（startTimestamp, endTimestamp）
  ↓
並列で3つのコレクションにアクセス（Promise.all）
  ├─ posts: userId + createdAt (期間フィルタ) → 期間内の投稿IDリスト取得
  ├─ analytics: userId + publishedAt (期間フィルタ) → 期間内の分析データ取得
  └─ plans: userId + snsType + status → 計画の有無確認
  ↓
データ整合性の処理
  ├─ 期間内の投稿ID（postIdsInPeriod）をSetで管理
  ├─ analyticsデータをpostIdでフィルタリング（期間内の投稿に対応するもののみ）
  ├─ publishedAtをDate型に統一（Timestamp → Date変換）
  └─ 同じpostIdに複数の分析データがある場合、最新のものを採用
  ↓
KPI集計
  ├─ totalLikes: いいね数の合計
  ├─ totalReach: リーチ数の合計
  ├─ totalSaves: 保存数の合計
  └─ totalComments: コメント数の合計
  ↓
スコア計算（calculatePerformanceScore）
  ├─ エンゲージメントスコア（最大50点）
  ├─ 成長スコア（最大25点）
  ├─ 品質スコア（最大15点）
  └─ 一貫性スコア（最大10点）
  ↓
ランク評価（S, A, B, C, D, F）
  ↓
レスポンス返却
  ↓
PerformanceScore コンポーネントで表示
```

---

## 特徴

### 1. シンプルな設計
- **1つのAPI**: `/api/analytics/performance-score` のみ
- **3つのコレクション**: 最小限のデータ取得
- **1つの状態**: `performanceScore` のみ

### 2. レスポンシブ対応
- モバイル、タブレット、デスクトップで適切に表示
- グリッドレイアウトが画面サイズに応じて調整

### 3. エラーハンドリング
- エラー状態の表示
- ローディング状態の表示
- データがない場合の処理

### 4. パフォーマンス最適化
- **クエリレベルでの期間フィルタリング**: `analytics`コレクションをクエリで期間フィルタリングし、全件取得を避けることでメモリ効率を向上
- **必要なデータのみ取得**: 期間外のデータを取得しないため、ネットワーク転送量とメモリ使用量を削減
- **並列データ取得**: `Promise.all`を使用して3つのコレクションに並列アクセス
- **型統一による安全な比較**: `publishedAt`を`Date`型に統一することで、比較演算を安全に実行
- **データ整合性の保証**: `postId`で投稿と分析データを紐付け、期間内の投稿に対応する分析データのみを使用

---

## 次のステップ

### フェーズ2: PDCA実行度追加
- `/api/analytics/pdca-execution-rate` API作成
- `PDCAExecutionRate` コンポーネント作成
- ページに追加

### フェーズ3: KPIコンソールページ
- `/instagram/report/kpi` ページ作成
- 詳細なKPI分析機能

---

## 既存ページとの比較

### 既存 `/instagram/monthly-report`
- **7つのAPI**
- **12個以上のコレクションアクセス**
- **19個のセクション**
- **複雑な状態管理**

### 新規 `/instagram/report`
- **1つのAPI** ✅
- **3つのコレクション** ✅
- **2つのセクション**（ヘッダー + パフォーマンス評価）✅
- **シンプルな状態管理** ✅

**削減率**: 
- API: 7 → 1（**86%削減**）
- コレクション: 12 → 3（**75%削減**）
- セクション: 19 → 2（**89%削減**）

