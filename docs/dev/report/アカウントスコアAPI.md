# アカウントスコアAPI

## エンドポイント
`GET /api/analytics/account-score`

## パラメータ
- `period`: `"weekly" | "monthly"` (デフォルト: `"monthly"`)
- `date`: `YYYY-MM` または `YYYY-WW` (オプション)

## 使用コレクション

### 1. `analytics` コレクション
**クエリ**:
```typescript
adminDb.collection("analytics")
  .where("userId", "==", uid)
  .get()
```
- **インデックス**: 不要（単一フィールドクエリ）
- **取得データ**: 全分析データ（期間フィルタリングはクライアント側で実行）
- **用途**: アカウントスコア計算

## データ処理フロー

1. **データ取得**
   - `analytics` コレクションから全データ取得

2. **期間フィルタリング**（クライアント側）
   - `period` と `date` に基づいてデータをフィルタリング

3. **スコア計算**
   - エンゲージメントスコア (50%): 平均エンゲージメント率 × 10
   - 成長スコア (25%): フォロワー増加数 × 0.05
   - 品質スコア (15%): 平均リーチ数 / 2000
   - 一貫性スコア (10%): 投稿頻度（週3回で10点）

4. **ランク評価**
   - S: 85点以上
   - A: 70点以上
   - B: 55点以上
   - C: 40点以上
   - D: 25点以上
   - F: 25点未満

5. **キャッシュ**
   - 10分間キャッシュ（`cache.set(cacheKey, result, 10 * 60 * 1000)`）

6. **レスポンス生成**
   - スコア、ランク、内訳をJSON形式で返却

## パフォーマンス課題

- **全件取得**: `analytics` を全件取得してからクライアント側でフィルタリング
- **キャッシュ**: 10分間キャッシュされているが、データ取得は毎回実行

## 推奨改善

1. **サーバー側フィルタリング**: 期間フィルタリングをサーバー側で実行
2. **インデックス**: 期間フィルタリング用のインデックスを追加

