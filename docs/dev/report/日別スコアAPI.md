# 日別スコアAPI

## エンドポイント
`GET /api/analytics/daily-scores`

## パラメータ
- `days`: 日数（デフォルト: `30`）

## 使用コレクション

### 1. `analytics` コレクション
**クエリ**:
```typescript
adminDb.collection("analytics")
  .where("userId", "==", uid)
  .get()
```
- **インデックス**: 不要（単一フィールドクエリ）
- **取得データ**: 全分析データ（期間フィルタリングはクライアント側で実行）
- **用途**: 日別スコア計算

### 2. `posts` コレクション
**クエリ**:
```typescript
adminDb.collection("posts")
  .where("userId", "==", uid)
  .get()
```
- **インデックス**: 不要（単一フィールドクエリ）
- **取得データ**: 全投稿データ（期間フィルタリングはクライアント側で実行）
- **用途**: 日別投稿数計算

## データ処理フロー

1. **データ取得**
   - `analytics` コレクションから全データ取得
   - `posts` コレクションから全データ取得

2. **期間計算**
   - 現在日時から `days` 日前までの期間を計算

3. **日別データ生成**
   - 各日について：
     - その日の `analytics` データをフィルタリング
     - その日の `posts` データをフィルタリング
     - アカウントスコアを計算（`account-score` と同じロジック）

4. **キャッシュ**
   - 5分間キャッシュ（`cache.set(cacheKey, result, 5 * 60 * 1000)`）

5. **レスポンス生成**
   - 日別スコア配列をJSON形式で返却

## パフォーマンス課題

- **全件取得**: `analytics` と `posts` を全件取得してからクライアント側でフィルタリング
- **日別ループ**: 各日についてデータをフィルタリング（非効率）

## 推奨改善

1. **サーバー側フィルタリング**: 期間フィルタリングをサーバー側で実行
2. **インデックス**: 期間フィルタリング用のインデックスを追加
3. **集約クエリ**: 日別集約をサーバー側で実行

