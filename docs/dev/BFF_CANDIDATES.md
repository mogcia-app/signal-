# BFF化すべきページ候補

## 📋 概要

フロントエンドで複雑な計算やビジネスロジックを実行しているページ、または複数のAPI呼び出しを管理しているページを特定し、BFF（Backend for Frontend）化の候補として整理しました。

---

## 🔴 優先度：高

### 1. 月次レポートページ (`/instagram/report`)

**現状の問題点**:
- **7つのAPIエンドポイント**を1つのページで使用
- 初期ロードで**4つのAPI**を並列実行
- ユーザー操作で**さらに3つのAPI**を実行
- **重複するコレクションアクセス**:
  - `analytics` コレクション: **5回**アクセス（全件取得が3回）
  - `posts` コレクション: **4回**アクセス（全件取得が2回）
- **合計24回のコレクションアクセス**（AI分析時）
- クライアント側で複雑なフィルタリングと計算を実行
- 状態管理が非常に複雑（7つの状態変数 + ローディング/エラー状態）

**使用しているAPI**:
1. `/api/analytics/monthly-report-summary` - メインサマリーデータ
2. `/api/analytics/daily-scores` - 日別スコア
3. `/api/analytics/account-score` (当月) - アカウントスコア
4. `/api/analytics/account-score` (前月) - 前月比較
5. `/api/analytics/monthly-review` - 月次レビュー
6. `/api/analytics/performance-score` - パフォーマンススコア
7. `/api/ai/monthly-analysis` - AI分析（オンデマンド）
8. `/api/analytics/action-logs` - アクションログ（条件付き）

**BFF化の提案**:
```
GET /api/analytics/monthly-report-complete?date={YYYY-MM}
  ├─ すべてのデータを1回で取得
  ├─ サーバー側で期間フィルタリング
  ├─ 重複データを排除
  └─ 必要なデータのみを返却
```

**メリット**:
- API呼び出しが1回に削減
- 状態管理が大幅に簡素化
- パフォーマンス向上（コレクションアクセス削減）
- 依存関係が明確化
- クライアント側の計算処理を削減

**参考ドキュメント**: `docs/dev/report/現状の問題点まとめ.md`, `docs/dev/MONTHLY_REPORT_COMPLEXITY.md`

---

## 🟡 優先度：中

### 2. 投稿一覧ページ (`/instagram/posts`)

**現状の問題点**:
- 投稿データと分析データを結合してフィルタリング
- `useMemo`で複雑な計算を実行（タブカウント、フィルタリング）
- 投稿と分析データの関連付けをクライアント側で実行

**使用しているAPI**:
1. `/api/posts` - 投稿データ取得
2. `/api/analytics` - 分析データ取得

**BFF化の提案**:
```
GET /api/posts/with-analytics
  ├─ 投稿データと分析データを結合
  ├─ 分析済み/未分析の分類
  ├─ タブカウントの計算
  └─ フィルタリング済みデータを返却
```

**メリット**:
- クライアント側の計算処理を削減
- 状態管理の簡素化
- パフォーマンス向上

---

### 3. KPIダッシュボードページ (`/instagram/kpi`)

**現状の問題点**:
- 1つのAPIから多くのデータを取得して複数の状態変数で管理
- 月ごとのデータ取得と状態管理が複雑

**使用しているAPI**:
1. `/api/analytics/kpi-breakdown` - KPI分解データ（すべてのデータを含む）

**BFF化の提案**:
```
既にBFF的な構造になっているが、以下の改善が可能:
- データ取得の最適化
- キャッシュ戦略の改善
- 状態管理の簡素化
```

**メリット**:
- データ取得の効率化
- 状態管理の簡素化

---

### 4. Instagramダッシュボード (`/instagram/page`)

**現状の問題点**:
- 複数のAPIを並列実行して統計を計算
- データ取得と計算処理が複雑

**使用しているAPI**:
1. `/api/instagram/dashboard-charts` - ダッシュボード統計
2. `/api/posts` - 投稿データ
3. `/api/analytics` - 分析データ
4. `/api/instagram/performance-summary` - パフォーマンスサマリー
5. `/api/instagram/goal-progress` - 目標進捗
6. `/api/instagram/next-actions` - 次のアクション

**BFF化の提案**:
```
GET /api/instagram/dashboard-complete
  ├─ すべてのダッシュボードデータを1回で取得
  ├─ 統計計算をサーバー側で実行
  └─ 必要なデータのみを返却
```

**メリット**:
- API呼び出しの削減
- 計算処理のサーバー側移行
- 状態管理の簡素化

---

### 5. ホームページ (`/home`)

**現状の問題点**:
- 複数のAPI呼び出しとデータ集約
- 状態管理が複雑

**使用しているAPI**:
- 複数のAPIを呼び出してデータを集約

**BFF化の提案**:
```
GET /api/home/dashboard
  ├─ ホーム画面に必要なすべてのデータを取得
  └─ 集約済みデータを返却
```

**メリット**:
- API呼び出しの削減
- 状態管理の簡素化

---

## 🟢 優先度：低

### 6. 学習ダッシュボード (`/learning`)

**現状の問題点**:
- 複数のAPI呼び出し
- データの集約処理

**使用しているAPI**:
1. `/api/ai/master-context` - マスターコンテキスト

**BFF化の提案**:
```
既にマスターコンテキストAPIがあるが、以下の改善が可能:
- データ取得の最適化
- キャッシュ戦略の改善
```

---

### 7. 投稿分析ページ (`/analytics/feed`, `/instagram/analytics/reel`)

**現状の問題点**:
- 投稿データと分析データの関連付け
- クライアント側での計算処理

**BFF化の提案**:
```
既存のAPIを改善:
- データの結合処理をサーバー側で実行
- 計算処理のサーバー側移行
```

---

## 📊 優先度サマリー

| ページ | 優先度 | API呼び出し数 | コレクションアクセス | 状態管理の複雑さ | BFF化の緊急度 |
|--------|--------|--------------|-------------------|----------------|--------------|
| `/instagram/report` | 🔴 高 | 7-8個 | 24回 | 非常に高い | ⚡ 最優先 |
| `/instagram/posts` | 🟡 中 | 2個 | - | 中 | 中 |
| `/instagram/kpi` | 🟡 中 | 1個 | - | 中 | 低 |
| `/instagram/page` | 🟡 中 | 6個 | - | 中 | 中 |
| `/home` | 🟡 中 | 複数 | - | 中 | 低 |
| `/learning` | 🟢 低 | 1個 | - | 低 | 低 |
| `/analytics/feed` | 🟢 低 | 複数 | - | 低 | 低 |

---

## 🎯 推奨される実装順序

### Phase 1: 最優先（即座に対応すべき）
1. **月次レポートページ (`/instagram/report`)** - 最も複雑で問題が多い

### Phase 2: 中期（次に対応すべき）
2. **Instagramダッシュボード (`/instagram/page`)** - 複数のAPI呼び出し
3. **投稿一覧ページ (`/instagram/posts`)** - データ結合処理の最適化

### Phase 3: 長期（余裕があれば対応）
4. **ホームページ (`/home`)** - API呼び出しの最適化
5. **KPIダッシュボード (`/instagram/kpi`)** - データ取得の最適化
6. **その他のページ** - 必要に応じて改善

---

## 💡 BFF化の一般的なベネフィット

1. **パフォーマンス向上**
   - API呼び出しの削減
   - ネットワーク通信の削減
   - サーバー側での計算処理

2. **状態管理の簡素化**
   - 状態変数の削減
   - ローディング/エラー状態の簡素化
   - 依存関係の明確化

3. **保守性の向上**
   - ビジネスロジックの集約
   - テスト容易性の向上
   - コードの重複削減

4. **スケーラビリティの向上**
   - サーバー側でのキャッシュ戦略
   - データベースアクセスの最適化
   - リソース使用量の削減

---

## 📝 参考ドキュメント

- `docs/dev/report/現状の問題点まとめ.md` - 月次レポートページの詳細分析
- `docs/dev/MONTHLY_REPORT_COMPLEXITY.md` - 月次レポートページの複雑性分析
- `docs/dev/report/API複雑性の可視化.md` - API複雑性の可視化

