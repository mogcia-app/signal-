# LLM 投稿戦略パイプライン構想

## 実装ステータス（2025-11-15 時点）
- [x] 1. ゴールド / ネガティブ投稿の抽出ロジック
- [x] 2. LLM 生成プロンプト構成（共通レスポンス化・マスターコンテキスト連携）
- [x] 3. 学習ダッシュボード拡張（KPIハイライト・根拠表示・タスク化）
- [x] 4. Lab 投稿エディター優先実装事項（AI提案ボード / 参照表示）
- [x] 5. 月次レポート拡張案（投稿ディープダイブ / 翌月アクション）
- [x] 6. A/B テスト × LLM 連携（登録フロー / レポート表示）
- [x] 7. 投稿本文構造 × NLP 特徴量の自動抽出
- [x] 8. ペルソナ別反応パターンの抽出・可視化
- [x] 9. 投稿間の差分（Δ）算出と LLM 連携
- [x] 11. 時間帯 × コンテンツタイプのヒートマップ
- [x] 12. KPI 分解とドリルダウン UI
- [x] 13. フィードバック感情トラッキング
- [x] その他ロードマップ項目（A/B結果の自動反映 等）
- [x] その他ロードマップ項目（A/B結果の自動反映 等）

## 1. ゴールド / ネガティブ投稿の抽出ロジック

- **対象データ**: `posts` コレクション（or `analytics` 集計）から期間内の Instagram 投稿指標を取得  
- **入力 KPI**  
  - いいね数 (`likeCount`)  
  - 保存数 (`saveCount`)  
  - コメント数 (`commentCount`)  
  - リーチ (`reach`)  
  - エンゲージメント率（(いいね + コメント + 保存) / リーチ）  
- **前処理**  
  - アカウント規模補正：フォロワー数で正規化して「リーチ率」「保存率」などを算出  
  - 発生時期の補正：直近 N 件 vs 過去平均を比較して異常値を検知  
- **スコアリング**  
  - 指標ごとに Z スコア or Percentile を算出  
  - 重み付きスコア `score = w1*engagementRate + w2*saveRate + w3*reachGrowth`  
  - `score >= +1σ` を **ゴールド**、`score <= -1σ` を **ネガティブ** としてタグ付け  
- **メタ情報**  
  - 投稿本文 / タグ / メディアタイプ / 曜日 / 投稿時間帯  
  - ゴール（`campaignGoal`）や AI 生成フラグなど、生成プロンプトの根拠になる属性を保持  
- **保存先**  
  - `postPerformanceSnapshots` サブコレクションに日次バッチで保存  
  - LLM へ渡す際は最新 30 件のゴールド＋ネガティブ投稿要約を取得

## 2. LLM 生成プロンプト構成

```
SYSTEM:
あなたはInstagram特化のマーケター。ゴールド投稿の成功パターンを活用しつつ、ネガティブ投稿の失敗要因を避けるよう指示する。

USER INPUT:
- 投稿目的: {campaignGoal}
- KPI 状況: {kpiStatusSummary}
- ゴールド投稿要約:
  1. {goldSummary1}（指標: いいね {likeDelta}% ↑, 保存 {saveDelta}% ↑, 特徴: {angles}）
  ...
- ネガティブ投稿警告:
  1. {negativeSummary1}（指標: いいね {likeDelta}% ↓, 失敗要因: {issues}）
- ターゲット: {targetAudience}
- ブランド情報: {businessInfo}

ASSISTANT OUTPUT:
- 投稿案タイトル
- 投稿本文（見出し + 本文 + CTA）
- 推奨ハッシュタグ
- KPI 改善根拠（ゴールド引用・ネガティブ回避要因・現在の KPI 補正）
```

## 3. 学習ダッシュボード拡張案

- **KPI ハイライト**: 直近 30 日の主要 KPI トレンドをカード表示  
  - 例: 「いいね率 -12%」「保存率 +8%」「リーチ 横ばい」  
- **推奨アクション**  
  - ゴールド投稿から抽出した成功フレーズ / CTA / クリエイティブ要素  
  - ネガティブ投稿から回避すべき要素（例: 「長文で離脱」「ハッシュタグ不足」）  
- **LLM 生成の根拠表示**  
  - 投稿生成カードに「根拠: ゴールド投稿 #123 の CTA を引用」「失敗例 #456 の量産投稿を回避」などを表示  
- **タスク化**  
  - KPI 低下項目に対して「LLM 生成案を見る」「再投稿する」などのアクションボタンを配置  
- **将来拡張**  
  - A/B テスト結果の自動取り込み → ゴールドタグ付けに反映  
  - 投稿後のパフォーマンスをフィードバックし、生成プロンプトに自動追加


## 4. Lab 投稿エディター優先実装事項（POINT 02 対応）

- **目的**: 企画書「POINT 02 投稿ネタ切れを解消」で訴求する体験を早期に実現。ラボ内の投稿エディター UI を基点に、AI から提案された切り口・本文・画像案・優先度をワンビューで示す。  
- **UI 方針**  
  - `Lab` 投稿エディター画面をベースにスクリーンショットを取得し、企画書に掲載。  
  - 画面左: 生成された投稿ドラフト（タイトル・本文・CTA・ハッシュタグ）。  
  - 画面右（または上部カード）:  
    - 切り口／表現の切り替え案  
    - 画像テイストやビジュアル指示（例: 「コスメのマクロ写真」「Before/After 比較」など）  
    - アカウント全体の優先度（例: 「保存率を伸ばす施策」「リーチ改善施策」）  
- **バックエンド要件**  
  - セクション 1 のゴールド／ネガティブ抽出結果を UI へ供給する GraphQL/REST エンドポイント。  
  - セクション 2 のプロンプトに `campaignGoal`, `kpiStatusSummary`, `goldSummary`, `negativeSummary` を埋め込み、`Lab` エディターの「提案取得」ボタンから呼び出す。  
  - 提案レスポンスは `draft`, `insights`, `imageHints`, `priority` などのフィールドで返却し、UI はそれぞれのカードにバインド。  
- **開発タスク**  
  1. 投稿エディター UI の設計アップデート（AI 提案ボード／画像ヒント欄を追加）。  
  2. LLM 呼び出し API の実装とレスポンススキーマ定義。  
  3. 生成結果を保存／再編集できる Draft モデルの拡張。  
  4. 企画書用のスクリーンショット素材（AI 提案付きエディター）をキャプチャ。  
- **成果物**  
  - POINT 02 セクション横に掲載するラボ投稿エディターのスクリーンショット。  
  - 「ネタ提案 → 具体的な投稿案 → 優先度」の一連の流れが UI として確認できるデモ環境。


## 5. 月次レポート拡張案（POINT 04 対応）

- **目的**: 公式アプリにはない “投稿一件ごとの改善ヒントと翌月アクション” まで踏み込んだレポートを提供し、POINT 04（詳細分析の自動化）を訴求できる状態にする。  
- **既存の分析項目（`src/app/instagram/monthly-report/page.tsx`）**  
  - KPI 概要 (`ReportHeader`, `PerformanceRating`, `MetricsCards`)  
  - AI サマリー＆PDCA メトリクス (`AIPredictionAnalysis`, `RiskAlerts`, `PostTypeInsights`)  
  - 詳細統計・可視化・高度分析 (`DetailedStats`, `VisualizationSection`, `AdvancedAnalysis`)  
- **追加したい要素**  
  1. **投稿ディープダイブ**: `postPerformanceSnapshots` と投稿詳細に保存された AI アドバイスを参照し、各投稿の実績・フィードバック・AI 提案を1枚にまとめるカード。  
  2. **ゴールド／ネガティブ共通点**: セクション1で算出したゴールド／ネガティブ群を比較し、「成功パターン」「改善が必要な共通要素」をタグ付きで表示。  
  3. **翌月アクションパネル**: AI が抽出した課題ごとに「フォーカスすべき KPI」「おすすめ投稿タイプ」「対策内容」を列挙。予約投稿やラボのタスクと連動。  
  4. **AI アドバイス履歴**: 投稿詳細に保存済みの AI コメントやユーザーフィードバックをタイムライン化し、学習ダッシュボードとつなげる。  
- **バックエンド／データ要件**  
  - 投稿単位の `aiInsights`（本文アドバイス、改善提案、採用可否）を月次レポート API に含める。  
  - ゴールド／ネガティブ集計 API をレポート側でも再利用できるよう、BFF に共通エンドポイントを追加。  
  - 月次レビュー API (`/api/analytics/monthly-review`) のレスポンスに “次月アクション” 用のフィールドを追加。  
- **UI/実装タスク**  
  1. `DetailedStats` か新規 `PostDeepDiveSection` コンポーネントで投稿カード群を表示。  
  2. `AIPredictionAnalysis` で返却するアラート／ハイライトにネガティブ共通点も含めるよう拡張。  
  3. `OverviewHistorySection` に投稿アドバイス履歴を紐付け、学習ダッシュボードとの一貫性を担保。  
  4. 月次レポート画面のスクリーンショットを企画書 POINT 04 に掲載（10 項目以上の分析 UI を可視化）。  
- **成果物**  
  - 投稿別の改善ヒントと翌月アクションを含む月次レポート UI。  
  - 企画書 POINT 04 で「詳細分析 10+ 項目＋AI 提案が一体化している」ことを証明するスクリーンショット／デモ。

- **コピー案**  
  - 「単なる集計ではなく、今月の投稿一件一件から見える“改善ヒント”を AI が抽出。結果を踏まえて来月どう動けばいいかまで提案します。」  
  - 「月次・週次レポートで 10 項目以上の KPI を一括集計しつつ、投稿カードで実績・AI アドバイス・フィードバックを確認。ゴールド／ネガティブ共通点から成功・失敗パターンを可視化し、重点 KPI と具体施策をその場で提案します。」


## 6. A/B テスト × LLM 連携アイデア

- **目的**: 投稿クリエイティブや CTA の A/B テスト結果を自動収集し、成功パターンを LLM プロンプトとレポートへフィードバック。  
- **A/B テストの流れ**  
  1. `Lab` で 2～3 パターンの投稿案を生成し、A/B テストとして登録。  
  2. 投稿後、Instagram API or 手動入力で実績データを取得。  
  3. `postPerformanceSnapshots` にテストグループ情報を保存し、ゴールド/ネガティブ抽出時に「勝ちパターン」「負けパターン」をタグ付け。  
- **LLM への活用**  
  - SYSTEM／USER プロンプトに「勝率が高い CTA」「避けるべき表現」など A/B テスト結果を埋め込み、次回生成に反映。  
  - 学習ダッシュボードや月次レポートの “成功／改善投稿” カードにテスト結果を表示し、意思決定の根拠にする。  
- **UI/実装タスク**  
  - `Lab` に A/B テスト登録フォームと結果確認タブを追加。  
  - 月次レポートに “A/B テスト結果” セクションを新設し、勝率・差分指標・次アクションを提示。  
  - ゴールド判定ロジックにテストメタ情報を追加し、成功パターン抽出の精度を向上。


## 7. 投稿本文構造 × NLP 特徴量

- **目的**: 数値指標だけでなく投稿本文の“構造”から成功／失敗要因を説明できるようにする。  
- **解析対象（半自動 or LLM 補助）**  
  - 文字数、ハッシュタグ数・ジャンル  
  - 導入 → 本文 → CTA の段落構成  
  - 結論先出し／ストーリー型／箇条書きの有無  
- **保存先**: `postPerformanceSnapshots` に `textFeatures` として保存し、ゴールド／ネガティブ抽出時にメタ情報を付与。  
- **活用箇所**  
  - LLM プロンプトに “成功パターン = 短い導入＋箇条書き CTA” などを渡し、投稿エディターで再現。  
  - 月次レポートの投稿ディープダイブに構造タグを表示し、「ゴールド投稿は CTA が明確」「ネガティブ投稿は段落が長すぎる」などの気づきを提示。


## 8. ペルソナ別反応パターンの抽出

- **目的**: ターゲット情報と KPI を紐付け、「誰に刺さったか／刺さらなかったか」を明示して Lab の優先度に反映。  
- **データ要素**  
  - `audienceAnalysis`（性別・年齢）＋ 投稿ごとのエンゲージメントをマッピングし、ペルソナ単位で保存率・いいね率などを算出。  
  - 例: 「24–34 女性は保存率が +18%」「40代男性はクリック率が高い」。  
- **活用**  
  - Lab の優先度パネルに “どのペルソナ向けの投稿か” を表示し、提案のフォーカスを明確化。  
  - 月次レポートや学習ダッシュボードに「ペルソナ別ハイライト」カードを追加し、戦略会議の資料として使えるようにする。


## 9. 投稿間の差分（Δ）を LLM へ入力

- **目的**: Z スコアだけでなく “直近 vs 過去平均” の変化量を LLM に渡し、「何が効いているか」を具体的に説明できるようにする。  
- **差分例**  
  - 直近 10 件で保存率が +18% 改善  
  - 投稿時間変更でリーチが +22%  
  - ハッシュタグ数を減らした結果クリック率が -30%  
- **実装メモ**  
  - `postPerformanceSnapshots` に `deltaMetrics` を追加し、期間比較の結果を保存。  
  - LLM プロンプトに `deltaMetrics` を埋め込み、投稿エディターや月次レポートのコメントで “施策と効果” をセットで提示。  
  - 学習ダッシュボードの KPI ハイライトにも差分情報を載せ、改善サイクルが見えるようにする。


## 11. 時間帯 × コンテンツタイプのヒートマップ

- **目的**: 「どの時間帯 × 投稿タイプで反応が取れているか」を直感的に把握し、来月の投稿計画（特にPOINT 04の詳細分析）に活用する。  
- **データ設計**  
  - 月次サマリー API (`/api/analytics/monthly-report-summary`) で `timeSlotAnalysis` を拡張し、6区分の時間帯 × 3投稿タイプ（Feed/Reel/Story）の投稿数と平均エンゲージメント pt を算出。  
  - `postTypes` 配列に `{ type, count, avgEngagement }` を格納し、LLM からも再利用できるようにする。  
- **UI 実装**  
  - `TimeSlotHeatmap` コンポーネント（KPIコンソールタブ）で、時間帯を縦軸・コンテンツタイプを横軸にしたヒートマップテーブルを表示。  
  - 各セルは投稿数と平均 ER を表示し、平均 ER に応じた濃淡で視覚化。  
- **今後の応用**  
  - ヒートマップ上のセルをクリックすると該当投稿リストや Lab へのショートカットを表示。  
  - LLM プロンプトへ「高反応の時間帯 × タイプ」情報を渡し、提案タイトルに投稿時間の推奨を含める。


## 10. 実装優先度と段階的ロードマップ

1. **基盤データ整備**  
   - `postPerformanceSnapshots` 生成バッチ、ゴールド／ネガティブ抽出、`deltaMetrics`、`textFeatures` フィールド追加。  
   - LLM 呼び出し API の共通スキーマ定義（`draft`, `insights`, `imageHints`, `priority` など）。

2. **Lab 投稿エディター（POINT 02）**  
   - AI 提案ボード、画像ヒント、優先度カードの UI 実装。  
   - ゴールド／ネガティブ情報と LLM 生成結果を表示し、企画書用スクショを取得。

3. **月次レポート拡張（POINT 04）**  
   - 投稿ディープダイブ、ゴールド／ネガ共通点、翌月アクション、AI アドバイス履歴の各セクション実装。  
   - A/B テスト用フィールドを先に仕込み、表示 UI の枠も作成。

4. **学習ダッシュボード & マスターコンテキスト（POINT 03/05）**  
   - マイアカウント設定と LLM プロンプトの接続状況を可視化。  
   - 学習バッジ、ペルソナ別ハイライト、フィードバック履歴の連動を強化。

5. **A/B テスト + 追加分析（POINT 06〜9）**  
   - Lab でのテスト登録→結果保存→レポート反映のワークフロー。  
   - NLP 特徴量・ペルソナ分析・差分メトリクスを LLM とレポートに統合し、改善提案の精度を上げる。


## 11. 時間帯 × コンテンツタイプのヒートマップ

- **目的**: 投稿時間帯・曜日とコンテンツ形式（画像/リール/カルーセル/動画など）の組み合わせで反応の良し悪しを瞬時に把握。  
- **データ処理**  
  - `reportSummary.timeSlotAnalysis` を拡張し、投稿タイプ別の平均エンゲージメントを保持。  
  - クロス集計テーブルを生成し、「平日夜 × カルーセル = 保存率◎」などのパターンを抽出。  
- **UI**  
  - 月次レポートにヒートマップを追加し、セルクリックで該当投稿一覧へドリルダウン。  
  - Lab の投稿エディターでは「この時間帯で伸びているコンテンツタイプ」をバッジ表示。  
- **LLM 活用**  
  - プロンプトに「平日夜のカルーセルは保存率 +18%」などの知見を埋め込み、投稿案や計画提案に反映。


## 12. KPI 分解とドリルダウン

- **目的**: 主要 KPI（フォロワー増減、保存率、リーチなど）を要素分解し、異常値の原因を素早く特定。  
- **ロジック例**  
  - フォロワー増減 = 新規獲得 − 離脱（離脱要因: 投稿頻度、ネガ反応、内容の不一致）  
  - 保存率 = 保存数 / リーチ、リーチ = フィード + 探索 + プロフィール流入  
- **UI**  
  - 月次レポートのカードに “ドリルダウン” ボタンを設置 → クリックすると該当投稿・コメントサマリ・AI 推定要因を表示。  
  - 学習ダッシュボードでは KPI トレンド横に “原因推定” を添える。  
- **LLM連携**  
  - `deltaMetrics` と分解結果をプロンプトに渡し、「離脱が増えた理由」「時間帯変更でリーチが伸びた理由」を自然言語で説明。  
  - Lab での改善提案にも “原因 → 対策” がセットで表示される。
- **実装メモ**  
  - `/api/analytics/monthly-report-summary` が `kpiBreakdowns` を返すよう拡張。リーチは流入ソース別、保存・フォロワーは投稿タイプ別に内訳化し、トップ貢献投稿を添付。  
  - フロントでは `KPIDrilldownSection` を追加し、各 KPI カード内に内訳バーとトップ投稿のショートカット（Lab/分析へのリンク）を表示。

### エンゲージメント算出ポリシー（独自ロジックを明記）

- **定義**: Signal 上の「総エンゲージメント」「総インタラクション」は Instagram API のブラックボックス指標ではなく、`likes + comments + shares + saves`（リールは `reposts` を含む）の手入力データを合算した独自ロジック。
- **入力ソース**: Lab/Analytics フォーム (`FeedAnalyticsForm.tsx`, `ReelAnalyticsForm.tsx`) でユーザーが入力する各投稿の実績値。`interactionCount` 系フィールドも同じフォーム値を Firestore に保存したもの。
- **集計箇所**: `/api/analytics/monthly-report-summary` の `calculateFeedPerformanceStats` / `calculateReelPerformanceStats` で期間内投稿を集計し、`totalInteractionCount` と平均 ER を算出。ダッシュボード系 API でも同じ足し算で一貫。
- **目的**: 指標の再現性・透明性を担保し、「保存数を含める/含めない」「外部 API の仕様変更」などに影響されないようにする。ドキュメント上も独自算出であることを明示して顧客説明に使えるようにする。


## 13. フィードバック感情トラッキング

- **目的**: ユーザーが入力した満足/不満コメントを感情分析し、どの投稿タイプ・テーマで満足度が高いかを可視化。  
- **データ処理**  
  - 投稿詳細に保存されているフィードバックを LLM or Sentiment API でスコアリングし、`feedbackSentiment` を付与。  
  - “満足度の高い投稿 = ゴールド候補” としてタグ付けし、学習ダッシュボードやレポートに表示。  
- **UI**  
  - 月次レポートに「満足度マップ」カードを追加し、投稿タイプ別の感情スコアを可視化。  
  - フィードバック一覧から該当コメントをハイライトし、改善ヒントとともに表示。  
- **LLM活用**  
  - プロンプトに感情スコアを渡し、「ユーザーから好評だったポイント」「不満の理由」を根拠付きで提案。  
- **効果**  
  - 数値指標だけでは見えない “ユーザーの気持ち” を分析軸に加え、ネタ選定やトーン調整の判断材料にできる。
- **実装メモ**  
  - `/api/analytics/monthly-report-summary` が `ai_post_feedback` を期間フィルタリングし、ポジ/ネガ/ニュートラルの比率・コメントサンプル・投稿別の好感度スコアを `feedbackSentiment` として返却。  
  - 月次レポート AI タブに `FeedbackSentimentCard` を追加し、好評コメント・改善要望・ポジティブ投稿／要改善投稿を Lab/分析リンク付きでドリルダウン可視化。

## 14. その他ロードマップ項目（A/B結果の自動反映 等）

- **A/B結果の自動反映**  
  - `ab_tests` コレクションと投稿/スナップショットを突き合わせ、バリエーションに紐付いた `postId` へ自動で結果タグを付与。  
  - `/api/analytics/monthly-report-summary` と `/api/analytics/snapshots` のレスポンスに `abTestResults` を含め、Lab の SnapshotInsights／月次レポートの投稿ディープダイブで勝者/敗者・指標差分を即表示。  
  - `PostDeepDiveSection` では A/B テスト欄を追加し、Lab/分析画面へのショートカットを提供。  
- **LLM/学習連携**  
  - `buildAIContext` 経由で参照されたスナップショットにも A/B結果タグが含まれるため、Lab/レポートの AI 提案が「どのテスト結果を根拠にしているか」を自動表示できる。

[1 tool called]

今の仕様を実装に落とすなら、以下の順で進めるとスムーズです。

1. **データ基盤の整備（セクション1,7,8,9の準備）**  
   - `postPerformanceSnapshots` バッチとゴールド/ネガ抽出ロジックを最優先で作成。  
   - 併せて `textFeatures`, `deltaMetrics`, ペルソナ別指標のフィールドを設計。  
   - ここでアウトプットされるデータが Lab／レポート／学習ダッシュボードすべての土台になります。

2. **LLM 呼び出し API とスキーマ統一（セクション2）**  
   - `draft`, `insights`, `imageHints`, `priority`, `aiInsights` など共通レスポンスを決め、ラボ・レポート・ダッシュボードで使い回す。  
   - マスターコンテキスト／RAG 連携もこのタイミングで整備。

3. **Lab 投稿エディター拡張（セクション4）**  
   - AI 提案ボード、画像ヒント、優先度カード、A/B テスト登録 UI を追加。  
   - ゴールド/ネガのデータと LLM 結果を表示できるように配線し、POINT 02 のデモ・スクショを確保。

4. **月次レポート拡張（セクション5,6,11,12,13）**  
   - 投稿ディープダイブ、ゴールド/ネガ共通点、翌月アクション、AIアドバイス履歴。  
   - ヒートマップ、KPI ドリルダウン、感情トラッキングなど分析系 UI をここで順次追加。  
   - A/B テスト結果表示の枠だけでも先に作っておく。

5. **学習ダッシュボード & マスターコンテキスト可視化（セクション3,10,12,13）**  
   - マイアカウント設定→LLM への流れを見える化。  
   - 学習バッジやペルソナハイライト、フィードバック履歴を月次レポートの分析とつなげる。

  

### ① LLM 連携の共通化（Step 2）
- `post-generation` 以外の API も、`draft/insights/imageHints/priority/aiInsights` など共通レスポンスに揃える  
- マスターコンテキスト + RAG を一元管理し「どの情報を参照したか」を返す仕組みを固める  
- ここが揃うと Lab／レポート／学習ダッシュボードが同じ “AI結果” を再利用できるようになる

### ② Lab 投稿エディターの深掘り（Step 3）
- AI提案ボードや画像ヒント、優先度タグ、A/B テスト登録 UI を追加  
- 生成された案がゴールド/ネガのどこを参考にしたかをさらに可視化  
- このフェーズまで進むと、POINT 02 のスクショ・デモがかなり説得力アップ

### ③ 月次レポートのディープダイブ＆学習ダッシュボード（Step 4-5）
- 投稿ディープダイブ、翌月アクション、AIアドバイス履歴などを月次タブに拡張  
- 学習ダッシュボード側でマスターコンテキスト・バッジ・フィードバック履歴を見える化  
- Lab／月次／ダッシュボードを同じスナップショット＆LLMレスポンスで連携させる仕上げフェーズ

---

「今すぐユーザーが触れる価値」を上げたいなら ②（Lab 強化）から、AIパイプラインを更に拡張して他の画面にも一気に広げたいなら ① → ③ の順が良さそうです。どこから着手するか一緒に決めましょう！