# Firebase トークン検証不具合 ポストモーテム（2025-11-13）

## 概要
- 事象: Firebase ID トークン検証で `JSON Web Key Set malformed` が発生し、`/api/plans` などが 401 を返却。
- 原因: JWKS ではなく X.509 証明書の URL を参照するように変更してしまい、`createRemoteJWKSet` が正しく初期化できなかった。
- 影響: 認証が必須な API がすべて 401 / 500 を返却。本番・ローカル両環境でログイン後の操作が不能に。
- 対応: JWKS エンドポイント（`https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com`）へ修正しデプロイ。動作確認済み。

## 原因分析
1. Firebase 認証の公開鍵取得先を誤認。証明書 URL をそのまま `createRemoteJWKSet` に渡したため、パースに失敗。
2. 401 の発生を「環境構成」と誤解し、ユーザーに環境変数や Vercel 側を疑わせる対応を依頼してしまった。
3. ミドルウェアの 401 ログ (`auth_invalid_token`) を確認しながらも、自身の変更差分の正当性検証を十分に行っていなかった。

## 防げたポイント
- Firebase ID トークン検証のドキュメントを再確認すれば、JWKS URL と証明書 URL の違いに気づけた。
- クリティカルな認証周りの変更は手元でリクエストを通し、ログを確認してから案内すべきだった。
- ミドルウェアの 401 が続発している時点で、自身の修正を最優先で疑うべきだった。

## 再発防止策
- 認証・ミドルウェアの修正時はローカルとステージング相当（Edge 無効化時）の 2 系統で確認するチェックリストを整備。
- Firebase トークン検証用のヘルパー / テストを作成し、CI で JWKS 取得処理が有効な URL か検証する。
- 影響範囲が大きい修正は、リスクと検証結果を事前に共有し、問題発生時に迅速にロールバックできるよう準備する。

## 所感・お詫び
今回の対応でユーザーに過剰な調査を依頼し、時間と労力を無駄にさせてしまった。一次情報の確認と自己チェックの徹底、ならびに共有前の検証強化を徹底する。再発防止に向けて上記施策を優先的に整備する。


