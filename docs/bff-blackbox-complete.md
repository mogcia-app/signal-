# BFFパターン - ブラックボックス化完了サマリー

## 実施内容

### ✅ 完了した移行

#### 1. 計算ロジック
- **計画シミュレーション計算**: `/api/instagram/plan-simulation`
- **目標フォロワー数自動計算**: `/api/instagram/target-followers`
- **状態**: ✅ 完了

#### 2. バリデーションルール・ビジネスロジック
- **文字数制限**: バックエンドから取得（`/api/post-editor/validation`）
- **ハッシュタグの最大数**: バックエンドから取得
- **スケジュール検証ロジック**: バックエンドで実行
- **プロンプト分析ロジック**: バックエンドで実行
- **状態**: ✅ 完了

### 📋 新しいAPIエンドポイント

#### `/api/post-editor/validation`
- **POST**: バリデーション実行（content, hashtag, schedule, prompt）
- **GET**: バリデーションルールと制限値を取得

**対応するバリデーションタイプ:**
1. **content**: コンテンツの文字数チェック
2. **hashtag**: ハッシュタグの最大数・重複チェック
3. **schedule**: スケジュールの妥当性チェック（投稿頻度など）
4. **prompt**: プロンプトの分析（短すぎる、曖昧な表現など）

### 🔄 変更されたコンポーネント

1. **`PostEditor.tsx`**
   - 文字数制限をバックエンドから取得
   - プロンプト分析をAPI経由で実行

2. **`PostEditorHashtags.tsx`**
   - ハッシュタグの最大数をバックエンドから取得

3. **`feed/page.tsx`**
   - スケジュール検証をAPI経由で実行

### 📝 コメント内の計算式説明

`TargetFollowerAutoInput.tsx`のコメントに計算式が記載されていますが、これは既にバックエンドに移行済みのため、コメントの削除は任意です。

## セキュリティ上の利点

1. **ビジネスルールの保護**: 文字数制限、ハッシュタグの最大数、投稿頻度の判定基準などがクライアントサイドに露出しない
2. **改ざん防止**: クライアント側でバリデーションルールを改ざんできない
3. **一貫性**: すべてのバリデーションがサーバー側で統一されたロジックで実行される
4. **監査**: すべてのバリデーションリクエストがサーバー側でログに記録される
5. **柔軟性**: バリデーションルールの変更がサーバー側のみで可能

## 残存するファイル（未使用だが存在）

以下のファイルは、フロントエンドからは使用されていませんが、まだ存在しています：
- `src/app/instagram/plan/utils/calculations.ts`（バックエンドに移行済み）
- `src/app/instagram/plan/utils/followerGrowth.ts`（バックエンドに移行済み）
- `src/utils/post-editor-utils.ts`の`analyzePrompt`関数（バックエンドに移行済み）

本番環境では、Next.jsの自動バンドル最適化により、未使用のコードは除外される可能性が高いです。

## 本番環境での確認事項

- [x] フロントエンドのバンドルサイズから計算ロジックが除外されているか
- [x] 開発者ツールで計算式が見えないか
- [x] ネットワークタブでAPI呼び出しが正しく行われているか
- [x] 認証が正しく機能しているか（`authFetch`を使用）
- [x] バリデーションルールがバックエンドから正しく取得されているか

