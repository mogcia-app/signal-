# エラー管理ガイド

Signal.プロジェクトにおけるエラー管理、監視、および定期チェックに関する包括的なガイドです。

## 目次

1. [エラーの種類](#エラーの種類)
2. [今後想定されるエラー](#今後想定されるエラー)
3. [毎月のエラーチェック項目](#毎月のエラーチェック項目)
4. [エラー対応フロー](#エラー対応フロー)
5. [エラー監視ツール](#エラー監視ツール)

---

## エラーの種類

### 1. システムエラー（System Errors）

#### 1.1 コード側のエラー
- **実行時エラー（Runtime Errors）**
  - null参照、undefinedアクセス
  - 型エラー（TypeScriptで一部防止）
  - 配列範囲外アクセス
- **APIエンドポイントのバグ**
  - ロジックエラー
  - データ処理の不具合
  - パラメータバリデーションエラー
- **レンダリングエラー**
  - Reactコンポーネントのレンダリングエラー
  - サーバーコンポーネントのエラー
  - Hydrationエラー

#### 1.2 データベースエラー
- **Firestoreエラー**
  - 接続エラー
  - 権限エラー（Firestore Rules違反）
  - データ不整合
  - タイムアウトエラー
- **データ不整合**
  - 期待されるデータ構造と異なる
  - 必須フィールドの欠損
  - 型の不一致

### 2. 外部サービスエラー（External Service Errors）

#### 2.1 インフラエラー
- **Vercel**
  - デプロイエラー
  - サーバーレス関数のタイムアウト
  - 関数実行制限の超過
- **Firebase**
  - 認証サービス障害
  - Firestore障害
  - Storage障害

#### 2.2 AIサービスエラー
- **OpenAI API**
  - APIキーの無効化
  - レート制限（429エラー）
  - タイムアウト
  - サービス障害
  - コスト制限の超過

### 3. 認証・認可エラー（Authentication & Authorization Errors）

- **認証エラー**
  - ログイン失敗
  - トークンの期限切れ
  - セッションの無効化
- **認可エラー**
  - 権限不足（403エラー）
  - 契約期間切れ
  - プラン制限によるアクセス拒否

### 4. レート制限エラー（Rate Limiting Errors）

- **429エラー（Too Many Requests）**
  - サーバー側のレート制限
  - API呼び出しの過剰
- **アカウント停止時の大量エラー**
  - 停止されたアカウントへのアクセス
  - 大量の403エラー

### 5. クライアントエラー（Client Errors）

- **4xxエラー**
  - 400 Bad Request（パラメータ不正）
  - 401 Unauthorized（認証が必要）
  - 403 Forbidden（権限不足）
  - 404 Not Found（リソース不存在）
- **ネットワークエラー**
  - タイムアウト
  - 接続エラー
  - CORSエラー

### 6. セキュリティエラー（Security Errors）

- **不正アクセス試行**
  - 不正なAPI呼び出し
  - 権限昇格の試行
  - SQLインジェクション試行
- **データ漏洩のリスク**
  - 個人情報の不適切な表示
  - 認証情報の漏洩

---

## 今後想定されるエラー

### 短期（1-3ヶ月）

#### 1. データ移行関連エラー
- **想定シナリオ**: データ構造の変更、コレクションの統合・分割
- **エラータイプ**: データ不整合、型エラー
- **対策**: 
  - 移行前のデータバックアップ
  - 段階的な移行と検証
  - ロールバック計画の準備

#### 2. 新機能追加時のエラー
- **想定シナリオ**: 新しいAPIエンドポイント、UIコンポーネントの追加
- **エラータイプ**: レンダリングエラー、APIバグ
- **対策**:
  - 型安全性の確保（TypeScript strict mode）
  - ビルド時のエラー検出
  - 段階的なロールアウト

#### 3. OpenAI API使用量の急増
- **想定シナリオ**: ユーザー数の増加、新機能によるAPI呼び出しの増加
- **エラータイプ**: レート制限、コスト超過
- **対策**:
  - 使用量の監視とアラート設定
  - レート制限の事前対応
  - フォールバック機能の実装

### 中期（3-6ヶ月）

#### 4. スケーリング関連エラー
- **想定シナリオ**: ユーザー数の大幅な増加
- **エラータイプ**: 
  - Vercelの関数実行制限
  - Firestoreのクエリパフォーマンス低下
  - タイムアウトエラーの増加
- **対策**:
  - パフォーマンスモニタリング
  - クエリの最適化
  - キャッシュ戦略の見直し

#### 5. セキュリティインシデント
- **想定シナリオ**: 不正アクセスの試行、脆弱性の悪用
- **エラータイプ**: セキュリティエラー、認証エラー
- **対策**:
  - セキュリティログの監視
  - 定期的なセキュリティ監査
  - 脆弱性スキャンの実施

#### 6. 依存ライブラリの更新によるエラー
- **想定シナリオ**: Next.js、React、Firebase SDKのメジャーアップデート
- **エラータイプ**: 互換性エラー、非推奨APIの使用
- **対策**:
  - 段階的なアップデート
  - テストの充実
  - 変更ログの確認

### 長期（6ヶ月以上）

#### 7. インフラの老朽化
- **想定シナリオ**: Vercel、Firebaseの仕様変更、料金体系の変更
- **エラータイプ**: サービス停止、API変更によるエラー
- **対策**:
  - 定期的なインフラレビュー
  - 代替案の検討
  - マルチクラウド戦略の検討

#### 8. データ容量・コストの問題
- **想定シナリオ**: Firestoreデータ量の増加、AI APIコストの増加
- **エラータイプ**: ストレージ制限、コスト超過によるサービス停止
- **対策**:
  - データアーカイブ戦略
  - コスト最適化の継続
  - 使用量の可視化とアラート

---

## 毎月のエラーチェック項目

### 1. Sentry監視の確認

#### 1.1 エラー数の確認
- [ ] 過去30日のエラー総数を確認
- [ ] 前月と比較してエラー数が増加していないか確認
- [ ] エラー数の急増がないか確認（スパイク検知）

#### 1.2 重要度の高いエラーの確認
- [ ] Critical/Errorレベルのエラーを確認
- [ ] 影響範囲が広いエラーの有無を確認
- [ ] ユーザーに直接影響するエラーの確認

#### 1.3 エラーの傾向分析
- [ ] 最も頻繁に発生しているエラートップ10を確認
- [ ] 新しいエラーの発生有無を確認
- [ ] 特定のエンドポイント/ページでのエラー集中を確認

#### 1.4 パフォーマンス問題の確認
- [ ] レスポンスタイムが遅いAPIエンドポイントを確認
- [ ] タイムアウトエラーの有無を確認
- [ ] メモリリークの兆候がないか確認

### 2. ログの確認

#### 2.1 サーバーログの確認
- [ ] Vercel Functionsのログを確認
- [ ] 異常なパターン（大量のリクエスト、不正なアクセス試行）がないか確認
- [ ] エラーログのパターン分析

#### 2.2 セキュリティログの確認
- [ ] `src/lib/server/logging.ts`のセキュリティログを確認
- [ ] 不正アクセス試行の有無を確認
- [ ] 認証エラーの増加がないか確認

##### IPアドレスと不正ログイン試行の監視

**現在の実装状況**:

1. **APIエンドポイントへの不正アクセス** ✅
   - `src/middleware.ts`でIPアドレスを取得・記録
   - 無効なトークンや空のトークンでアクセスした場合にログを記録
   - 記録される情報:
     - IPアドレス（`x-forwarded-for`、`x-real-ip`から取得）
     - User-Agent
     - パス、メソッド
     - エラー内容

2. **通常のログイン試行（メール/パスワード）** ⚠️
   - 現在、クライアントサイドでFirebase Authenticationに直接ログインしているため、サーバーサイドでは記録されていない
   - Firebase Consoleで確認可能:
     - Firebase Console → Authentication → Users → 各ユーザーの「Sign-in methods」タブ
     - 最終ログイン時刻、ログイン履歴が記録されている

3. **改善案（将来の実装）**:
   - ログインAPIエンドポイントを作成し、サーバーサイドでログイン処理を行う
   - ログイン試行（成功/失敗）を記録:
     - IPアドレス
     - メールアドレス（ハッシュ化推奨）
     - 試行時刻
     - 成功/失敗のステータス
     - エラーコード（失敗の場合）
   - 不正ログイン試行の検知:
     - 短時間での複数回の失敗試行
     - 複数のIPアドレスからの同一アカウントへの試行
     - 不正なメールアドレス形式での試行

**確認方法**:

1. **Sentryでセキュリティイベントを確認**（推奨）
   - **アクセス方法**: [Sentry.io](https://sentry.io)にログイン
   - **手順**:
     1. プロジェクトを選択
     2. 左メニューから「Issues」をクリック
     3. 検索バーで `tags[security_event]:*` と入力してフィルタリング
     4. または、検索バーで `auth_empty_token`、`auth_invalid_token`、`auth_missing_token` などで検索
   - **確認できる情報**:
     - IPアドレス（`security_payload.data.ip`に含まれる）
     - User-Agent（`security_payload.data.userAgent`に含まれる）
     - パス、メソッド（`security_payload.data.path`、`security_payload.data.method`）
     - エラー内容（`security_payload.data.error`）
     - タイムスタンプ
   - **詳細確認方法**:
     - イベントをクリック → 「Contexts」タブ → 「security_payload」セクションを展開
     - または「Extra」タブで詳細情報を確認

2. **Vercel Logsで確認**（Webhook URLが設定されていない場合）
   - **アクセス方法**: [Vercel Dashboard](https://vercel.com/dashboard)にログイン
   - **手順**:
     1. プロジェクトを選択
     2. 上部メニューから「Logs」タブをクリック
     3. 検索バーで `[WARN]` または `security_event` で検索
     4. または、`auth_empty_token`、`auth_invalid_token` などで検索
   - **確認できる情報**:
     - ログメッセージ（`[WARN] auth_empty_token`など）
     - IPアドレス、User-Agentなどの詳細データ（JSON形式）
     - タイムスタンプ
   - **注意**: Webhook URLが設定されている場合、ログは外部サービスに送信されるため、Vercel Logsには表示されません

3. **外部ログサービスで確認**（Webhook URLが設定されている場合）
   - **設定されている可能性のあるサービス**:
     - Datadog（`DATADOG_SECURITY_WEBHOOK_URL`が設定されている場合）
     - Google Cloud Logging / Stackdriver（`STACKDRIVER_WEBHOOK_URL`が設定されている場合）
     - その他のカスタムWebhook（`SECURITY_LOG_WEBHOOK_URL`が設定されている場合）
   - **確認方法**: 各サービスのダッシュボードで確認
   - **環境変数の確認**: Vercel Dashboard → Settings → Environment Variables で確認

4. **Firebase Consoleでログイン履歴を確認**
   - **アクセス方法**: [Firebase Console](https://console.firebase.google.com)にログイン
   - **手順**:
     1. プロジェクトを選択
     2. 左メニューから「Authentication」をクリック
     3. 「Users」タブを選択
     4. 各ユーザーをクリックして詳細を確認
   - **確認できる情報**:
     - 最終ログイン時刻（`Last sign in`）
     - 作成時刻（`Created`）
     - ログイン方法
   - **注意**: Firebase ConsoleではIPアドレスの詳細な記録は限定的です

**環境変数の確認方法**:
- Vercel Dashboard → プロジェクト → Settings → Environment Variables
- 以下の環境変数が設定されているか確認:
  - `SENTRY_DSN` または `NEXT_PUBLIC_SENTRY_DSN`（Sentryに送信する場合）
  - `SECURITY_LOG_WEBHOOK_URL`（カスタムWebhookに送信する場合）
  - `DATADOG_SECURITY_WEBHOOK_URL`（Datadogに送信する場合）
  - `STACKDRIVER_WEBHOOK_URL`（Stackdriverに送信する場合）

### 3. 外部サービス監視

#### 3.1 OpenAI API使用状況
- [ ] API使用量とコストを確認
- [ ] レート制限に達していないか確認
- [ ] エラー率（429エラーなど）を確認

#### 3.2 Firebase使用状況
- [ ] Firestoreの読み書き回数を確認
- [ ] Storage使用量を確認
- [ ] 認証サービスのエラー率を確認

#### 3.3 Vercel使用状況
- [ ] 関数の実行回数とエラー率を確認
- [ ] 帯域幅の使用状況を確認
- [ ] デプロイ履歴とデプロイエラーを確認

### 4. データベースの健全性チェック

#### 4.1 Firestoreデータの整合性
- [ ] 不正なデータ構造がないか確認
- [ ] 必須フィールドが欠損しているデータがないか確認
- [ ] 型の不一致がないか確認

#### 4.2 データ量の確認
- [ ] コレクションごとのデータ量を確認
- [ ] 異常に大きいドキュメントがないか確認
- [ ] 不要なデータの有無を確認

### 5. パフォーマンス監視

#### 5.1 ページ読み込み時間
- [ ] 主要ページの読み込み時間を確認
- [ ] 前月と比較してパフォーマンスが劣化していないか確認
- [ ] モバイルデバイスでのパフォーマンスを確認

#### 5.2 APIレスポンスタイム
- [ ] 主要APIエンドポイントのレスポンスタイムを確認
- [ ] 95パーセンタイル、99パーセンタイルを確認
- [ ] タイムアウト率を確認

### 6. セキュリティ監査

#### 6.1 脆弱性スキャン
- [ ] npm/yarnの依存関係の脆弱性を確認（`npm audit`）
- [ ] 既知の脆弱性がないか確認
- [ ] セキュリティパッチの適用状況を確認

#### 6.2 アクセス制御の確認
- [ ] Firestore Rulesが適切に設定されているか確認
- [ ] APIエンドポイントの認証・認可が正しく機能しているか確認
- [ ] プラン制限が正しく適用されているか確認

### 7. ユーザー影響の確認

#### 7.1 ユーザー報告の確認
- [ ] サポートへの問い合わせ内容を確認
- [ ] ユーザーから報告されたエラーを確認
- [ ] フィードバックやレビューでの問題報告を確認

#### 7.2 機能の動作確認
- [ ] 主要機能が正常に動作しているか手動確認
- [ ] 新機能の安定性を確認
- [ ] クロスブラウザ/クロスデバイスでの動作確認

### 8. コードベースの健全性

#### 8.1 ビルドエラーの確認
- [ ] TypeScriptの型エラーがないか確認
- [ ] ESLintエラーがないか確認
- [ ] ビルドが成功するか確認

#### 8.2 依存関係の更新
- [ ] 依存関係のアップデートがないか確認
- [ ] 非推奨パッケージがないか確認
- [ ] セキュリティパッチが利用可能か確認

---

## エラー対応フロー

### 1. エラーの検知

1. **自動検知**
   - Sentryによるエラー通知
   - ログ監視による異常検知
   - パフォーマンスモニタリングによる劣化検知

2. **手動検知**
   - ユーザーからの報告
   - 定期チェックでの発見
   - 開発中の発見

### 2. エラーの分類と優先度付け

#### 優先度：Critical（緊急）
- サービス全体が停止している
- ユーザーデータの漏洩リスク
- 決済機能の不具合

#### 優先度：High（高）
- 主要機能が動作しない
- 多数のユーザーに影響
- データの損失リスク

#### 優先度：Medium（中）
- 一部機能が動作しない
- 少数のユーザーに影響
- パフォーマンスの劣化

#### 優先度：Low（低）
- 軽微なUIの問題
- エッジケースでのエラー
- 警告レベルの問題

### 3. エラーの調査

1. **ログの確認**
   - Sentryでスタックトレースを確認
   - サーバーログで詳細を確認
   - セキュリティログで関連イベントを確認

2. **再現手順の確認**
   - エラーが再現可能か確認
   - 特定の条件でのみ発生するか確認
   - 影響を受けるユーザー層を確認

3. **影響範囲の特定**
   - 影響を受ける機能を特定
   - 影響を受けるユーザー数を確認
   - ビジネスへの影響を評価

### 4. エラーの修正

1. **修正方針の決定**
   - 一時的な回避策（Workaround）
   - 恒久的な修正（Fix）
   - ロールバックの検討

2. **修正の実装**
   - ローカル環境でのテスト
   - ステージング環境での検証
   - 本番環境へのデプロイ

3. **修正後の確認**
   - エラーが解消されたか確認
   - 副作用がないか確認
   - ユーザーへの影響が解消されたか確認

### 5. エラーの記録と振り返り

1. **エラーレポートの作成**
   - エラーの原因を記録
   - 対応内容を記録
   - 再発防止策を記録

2. **振り返り（Postmortem）**
   - エラーの根本原因を分析
   - 対応プロセスの改善点を特定
   - 予防策の見直し

---

## エラー監視ツール

### 1. Sentry

#### 設定
- **DSN**: `process.env.NEXT_PUBLIC_SENTRY_DSN`
- **トレースサンプリング**: 100%（本番環境では調整推奨）
- **無視するエラー**: ネットワークエラー、ResizeObserverエラーなど

#### 確認方法
1. Sentryダッシュボードにアクセス
2. プロジェクトを選択
3. Issuesタブでエラー一覧を確認
4. Performanceタブでパフォーマンス問題を確認

### 2. Vercel Logs

#### 確認方法
1. Vercelダッシュボードにアクセス
2. プロジェクトを選択
3. Logsタブでリアルタイムログを確認
4. Functionsタブで関数の実行状況を確認

### 3. Firebase Console

#### 確認方法
1. Firebase Consoleにアクセス
2. Firestore Databaseでデータを確認
3. Authenticationで認証エラーを確認
4. Storageで使用量を確認

### 4. OpenAI Dashboard

#### 確認方法
1. OpenAI Dashboardにアクセス
2. Usageタブで使用量とコストを確認
3. API Keysタブでキーの状態を確認

### 5. カスタムログ

#### セキュリティログ
- **場所**: `src/lib/server/logging.ts`
- **送信先**: Sentry + Webhook（設定されている場合）
- **確認方法**: Sentryのタグ「security_event」でフィルタリング

---

## チェックリストテンプレート

### 月次エラーチェック（YYYY年MM月）

#### 基本情報
- **チェック実施日**: YYYY-MM-DD
- **実施者**: [名前]
- **チェック期間**: 過去30日間

#### 1. Sentry監視
- [ ] エラー総数: [数値]件（前月: [数値]件）
- [ ] Critical/Errorレベルのエラー: [数値]件
- [ ] 新規エラー: [数値]件
- [ ] 影響範囲が広いエラー: [詳細]

#### 2. パフォーマンス
- [ ] 平均レスポンスタイム: [数値]ms
- [ ] タイムアウトエラー: [数値]件
- [ ] 遅いAPIエンドポイント: [詳細]

#### 3. 外部サービス
- [ ] OpenAI API使用量: [数値]（コスト: [金額]）
- [ ] Firestore使用量: [数値]
- [ ] Vercel関数実行数: [数値]

#### 4. セキュリティ
- [ ] 不正アクセス試行: [数値]件
- [ ] 認証エラー: [数値]件
- [ ] 脆弱性: [詳細]

#### 5. データベース
- [ ] データ不整合: [詳細]
- [ ] 異常に大きいデータ: [詳細]

#### 6. 対応が必要なエラー
- [ ] エラー1: [説明] - 優先度: [Critical/High/Medium/Low]
- [ ] エラー2: [説明] - 優先度: [Critical/High/Medium/Low]

#### 7. 備考
[その他の気づきや改善提案]

---

## 参考資料

- [Sentry設定ドキュメント](docs/sentry/SENTRY_SETUP.md)
- [セキュリティアーキテクチャ](docs/product/SECURITY_ARCHITECTURE.md)
- [削除影響分析（エラー想定）](docs/ops/DELETION_IMPACT_ANALYSIS.md)
- [本番環境エラーテスト](docs/ops/PROD_ERROR_TEST.md)

---

**最終更新日**: 2025-01-XX  
**次回レビュー予定**: 2025-02-XX

