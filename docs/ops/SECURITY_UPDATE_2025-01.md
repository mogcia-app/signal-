# セキュリティアップデート対応記録

**日付**: 2025年1月  
**対応者**: 開発チーム  
**重要度**: 🔴 緊急（CVSS 10.0）

## 概要

React Server Components（RSC）における重大なリモートコード実行（RCE）脆弱性が発見され、緊急対応を実施しました。

## 発見された脆弱性

### 第一弾の脆弱性（2025年1月対応）

#### CVE-2025-55182 (React)
- **深刻度**: CVSS 10.0（最大深刻度）
- **影響**: 認証なしでリモートコード実行が可能
- **原因**: React Server Componentsがペイロードを安全でない方法でデコードする論理的なデシリアライゼーションの問題
- **影響を受けるバージョン**:
  - `react-server-dom-webpack`: 19.0.0, 19.1.0, 19.1.1, 19.2.0
  - `react-server-dom-parcel`: 19.0.0, 19.1.0, 19.1.1, 19.2.0
  - `react-server-dom-turbopack`: 19.0.0, 19.1.0, 19.1.1, 19.2.0

#### CVE-2025-66478 (Next.js)
- **深刻度**: CVSS 10.0（最大深刻度）
- **影響**: Next.js App Routerを使用しているアプリケーションが同様の脆弱性の影響を受ける
- **影響を受けるバージョン**:
  - Next.js 14.3.0-canary.77以上
  - Next.js 15.x系
  - Next.js 16.x系

### 第二弾の脆弱性（2025年12月対応）

#### CVE-2025-55184 (DoS攻撃) - 重大度: 高
- **深刻度**: 高
- **影響**: サービス拒否（DoS）攻撃
- **原因**: 特別に細工されたHTTPリクエストを任意のApp Routerエンドポイントに送信すると、デシリアライズ時に無限ループが発生し、サーバープロセスがハングする
- **影響を受けるバージョン**:
  - Next.js >=13.3, 14.x, 15.x, 16.x
- **注意**: 最初の修正（CVE-2025-55184）は不完全で、完全な修正はCVE-2025-67779で公開

#### CVE-2025-55183 (ソースコードの露出) - 重大度: 中
- **深刻度**: 中
- **影響**: ソースコードの露出
- **原因**: 特別に細工されたHTTPリクエストにより、サーバー関数が他のサーバー関数のコンパイルされたソースコードを返す可能性がある
- **影響を受けるバージョン**:
  - Next.js 15.0.x, 15.1.x, 15.2.x, 15.3.x, 15.4.x, 15.5.x, 16.0.x
- **リスク**: ビジネスロジックの漏洩、シークレットの漏洩（コード内で直接定義されている場合）

#### CVE-2025-67779 (CVE-2025-55184の完全な修正)
- **深刻度**: 高
- **影響**: CVE-2025-55184の不完全な修正を完全に修正
- **重要**: 以前にCVE-2025-55184のパッチを適用した場合は、この修正も適用する必要がある

## プロジェクトへの影響

### アップデート前の状態

**第一弾対応時（2025年1月）**:
- **React**: `19.1.0` ❌ 影響あり
- **Next.js**: `15.5.3` ❌ 影響あり
- **react-dom**: `19.1.0` ❌ 影響あり

**第二弾対応時（2025年12月）**:
- **Next.js**: `15.5.7` ❌ 影響あり（CVE-2025-55183, CVE-2025-55184, CVE-2025-67779）

### 攻撃シナリオ
- 認証されていない攻撃者が悪意あるHTTPリクエストを送信
- サーバー上で任意のJavaScriptコードを実行可能
- React Server Functionエンドポイントを実装していなくても、RSCをサポートしていれば影響を受ける

## 実施した対応

### 1. 依存関係のアップデート

```json
{
  "dependencies": {
    "react": "^19.1.2",      // 19.1.0 → 19.1.2
    "react-dom": "^19.1.2",  // 19.1.0 → 19.1.2
    "next": "^15.5.7"        // 15.5.3 → 15.5.7
  },
  "devDependencies": {
    "eslint-config-next": "^15.5.7"  // 15.5.3 → 15.5.7
  }
}
```

### 2. 修正されたバージョン

**第一弾対応（2025年1月）**:
- **React**: 19.0.1, 19.1.2, 19.2.1 ✅
- **Next.js**: 15.0.5, 15.1.9, 15.2.6, 15.3.6, 15.4.8, 15.5.7, 16.0.7 ✅

**第二弾対応（2025年12月）**:
- **Next.js 15.5.x**: 15.5.9 ✅（CVE-2025-55183, CVE-2025-55184, CVE-2025-67779対応）
- **Next.js 15.0.x**: 15.0.7 ✅
- **Next.js 15.1.x**: 15.1.11 ✅
- **Next.js 15.2.x**: 15.2.8 ✅
- **Next.js 15.3.x**: 15.3.8 ✅
- **Next.js 15.4.x**: 15.4.10 ✅
- **Next.js 16.0.x**: 16.0.10 ✅
- **Next.js >=13.3, 14.x**: 14.2.35 ✅（DoS攻撃のみ対応）

### 3. 対応手順

1. **依存関係の確認**
   ```bash
   npm list react react-dom next
   ```

2. **package.jsonの更新**
   - React: `19.1.0` → `^19.1.2`
   - react-dom: `19.1.0` → `^19.1.2`
   - Next.js: `15.5.3` → `^15.5.7`
   - eslint-config-next: `15.5.3` → `^15.5.7`

3. **依存関係の再インストール**
   ```bash
   npm install
   ```

4. **追加の脆弱性修正**
   ```bash
   npm audit fix
   ```
   - js-yamlの脆弱性を修正
   - node-forgeの脆弱性を修正

5. **ビルドテスト**
   ```bash
   npm run build
   ```
   - ✅ ビルド成功
   - 警告は既存のコードスタイルに関するもので、ビルドエラーなし

6. **動作確認**
   ```bash
   npm run dev
   ```
   - ✅ 開発サーバー正常動作
   - ✅ エラーなし

7. **コミット・デプロイ**
   ```bash
   git add package.json package-lock.json
   git commit -m "security: Fix critical RCE vulnerabilities (CVE-2025-55182, CVE-2025-66478)"
   git push origin main
   ```

## アップデート後の状態

### インストール済みバージョン（確認済み）

**第一弾対応後**:
- **React**: `19.2.1` ✅ 修正版
- **react-dom**: `19.2.1` ✅ 修正版
- **Next.js**: `15.5.7` ✅ 修正版

**第二弾対応後（2025年12月）**:
- **React**: `19.2.1` ✅ 修正版（変更なし）
- **react-dom**: `19.2.1` ✅ 修正版（変更なし）
- **Next.js**: `15.5.9` ✅ 修正版（CVE-2025-55183, CVE-2025-55184, CVE-2025-67779対応）

### セキュリティ監査結果
```bash
npm audit
```
- ✅ **0 vulnerabilities**（すべて修正済み）

## Vercelでの保護

Vercelはこの脆弱性に対処するためのWAFルールを迅速に導入し、Vercelでホストされているすべてのプロジェクトが無料で自動的に保護されています。

ただし、ホスティングプロバイダーに関係なく、パッチを適用したバージョンにアップグレードすることが強く推奨されます。

## コミット情報

### 第一弾対応（2025年1月）
- **コミットハッシュ**: `16793563`
- **コミットメッセージ**: `security: Fix critical RCE vulnerabilities (CVE-2025-55182, CVE-2025-66478)`
- **変更ファイル**:
  - `package.json`
  - `package-lock.json`

### 第二弾対応（2025年12月）
- **対応日**: 2025年12月
- **コミットメッセージ**: `security: Fix RSC vulnerabilities (CVE-2025-55183, CVE-2025-55184, CVE-2025-67779)`
- **変更内容**:
  - Next.js: `15.5.7` → `15.5.9`
  - eslint-config-next: `15.5.7` → `15.5.9`

## 参考情報

### 第一弾の脆弱性
- [React Security Advisory](https://react.dev/blog/security)
- [Next.js Security Advisory](https://nextjs.org/security)
- [Wiz Research](https://www.wiz.io/blog)
- CVE-2025-55182: React Server Components RCE
- CVE-2025-66478: Next.js App Router RCE

### 第二弾の脆弱性
- [Next.js Security Advisory - CVE-2025-55183, CVE-2025-55184](https://nextjs.org/security)
- [React Blog - DoS and Source Code Exposure in React Server Components](https://react.dev/blog)
- CVE-2025-55184: DoS攻撃（最初の修正は不完全）
- CVE-2025-55183: ソースコードの露出
- CVE-2025-67779: CVE-2025-55184の完全な修正

## 今後の対策

1. **定期的なセキュリティ監査**
   ```bash
   npm audit
   npm audit fix
   ```

2. **依存関係の更新チェック**
   - セキュリティアラートの監視
   - 定期的な依存関係の更新

3. **自動化**
   - DependabotやRenovateの導入を検討
   - CI/CDパイプラインでのセキュリティチェック

## 確認事項

- [x] 依存関係のアップデート完了
- [x] ビルドテスト成功
- [x] 開発サーバー動作確認
- [x] npm auditで脆弱性0件確認
- [x] コミット完了
- [x] プッシュ完了
- [x] Vercelデプロイ完了

## 備考

### 第一弾の脆弱性について
- この脆弱性は、クラウド環境の39%が影響を受けていると報告されています
- 早急なアップデートが推奨される重大な脆弱性でした
- 本プロジェクトは迅速に対応し、すべての脆弱性を修正済みです

### 第二弾の脆弱性について
- React2Shellのパッチ検証中に新たに発見された脆弱性
- リモートコード実行は許さないが、DoS攻撃とソースコード露出のリスクがある
- CVE-2025-55184の最初の修正は不完全で、CVE-2025-67779で完全に修正された
- 本プロジェクトはNext.js 15.5.9にアップデートし、すべての脆弱性を修正済み

### 重要な注意事項
- **CVE-2025-55184の最初の修正は不完全でした**。以前にパッチを適用した場合は、最新のパッチ適用バージョン（15.5.9）に再度アップグレードする必要があります。
- Vercel WAFは追加の防御層を提供しますが、パッチを適用したバージョンにアップグレードすることが最も重要です。

