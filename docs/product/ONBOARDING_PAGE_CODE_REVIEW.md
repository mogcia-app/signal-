# オンボーディングページ (/onboarding) コードレビュー

**レビュー日**: 2026年1月22日

## 概要

オンボーディングページは、新規ユーザーが初回ログイン時にビジネス情報、目標・課題、SNS AI設定を段階的に入力するためのページです。3ステップのウィザード形式で、ユーザープロファイル情報を収集します。

## コード構造

### メインファイル
- `src/app/onboarding/page.tsx` (1680行) - 非常に大きなファイル

### 依存関係
- Firebase Firestore - データ保存
- `useAuth` - 認証状態管理
- `useUserProfile` - ユーザープロファイル管理
- `authFetch` - 認証付きHTTPリクエスト

## 主要機能

### ステップ1: ビジネス情報
- 業種の選択
- 会社規模の選択
- 事業形態の選択
- ターゲット市場の選択（複数選択可）
- キャッチコピーの入力
- 初期フォロワー数の入力
- 商品・サービス情報の追加・編集・削除

### ステップ2: 目標・課題
- 目標の選択（複数選択可）
- 課題の選択（複数選択可）
- カスタム目標・課題の追加

### ステップ3: SNS AI設定
- Instagram AI設定の有効化
- トーンの選択
- マナー・ルールの入力
- 注意事項・NGワードの入力
- 運用目標の入力
- 活動の動機の入力
- 機能の選択（複数選択可）

### その他機能
- パスワード変更機能
- 編集モード（既存データの編集）
- プログレスバー表示
- データの自動読み込み（既存プロファイルから）

## コードレビュー結果

### ✅ 良い点

1. **ステップワイズUI**
   - 3ステップのウィザード形式で分かりやすい
   - プログレスバーで進捗を可視化

2. **既存データの読み込み**
   - ユーザープロファイルから既存データを自動読み込み
   - 編集モードで既存データを更新可能

3. **バリデーション**
   - 必須項目のチェック
   - エラーメッセージの表示

4. **レスポンシブデザイン**
   - モバイル・デスクトップ対応

5. **状態管理**
   - 各ステップの状態を適切に管理
   - フォームデータの状態管理が適切

### ⚠️ 改善が必要な点

1. **ファイルサイズが大きすぎる**
   - 1680行の単一ファイル
   - **対応**: コンポーネント分割を強く推奨
     - 各ステップを独立したコンポーネントに
     - フォーム入力コンポーネントの共通化

2. **未使用の状態変数**
   ```typescript
   const [customFeature, setCustomFeature] = useState(""); // 定義されているが使用されていない
   ```
   - **対応**: 未使用の変数を削除

3. **コメントアウトされたコード**
   ```typescript
   // const getTargetMarketLabel = (value: string | string[]) => { ... }
   // const toneOptions = [ ... ]
   ```
   - **対応**: 不要なコードを削除

4. **重複したロジック**
   - ラベル変換関数（`getIndustryLabel`, `getCompanySizeLabel`, `getBusinessTypeLabel`）が類似
   - **対応**: 共通のマッピング関数に統合

5. **型安全性**
   - `snsAISettings`の型定義が複雑
   - 一部で型アサーションが必要
   - **対応**: 型定義の改善

6. **console.logの残存**
   ```typescript
   console.log("[Onboarding] Loading businessInfo from userProfile:", ...);
   ```
   - **対応**: 本番環境用に削除またはロガーに置き換え

7. **エラーハンドリングの不統一**
   - 一部のエラー処理が不十分
   - **対応**: エラーハンドリングの統一

8. **状態変数の過多**
   - 多数の状態変数が定義されている
   - **対応**: 状態管理の整理（useReducerや状態オブジェクトの検討）

9. **フォームバリデーション**
   - バリデーションロジックが分散
   - **対応**: バリデーション関数の集約

10. **パフォーマンス**
    - 大きなファイルによる初期ロードへの影響
    - **対応**: コード分割・動的インポートの検討

### 🔧 推奨される改善

1. **コンポーネント分割**
   ```typescript
   // 推奨構造
   components/
     Step1BusinessInfo.tsx
     Step2GoalsChallenges.tsx
     Step3SNSAISettings.tsx
     PasswordChangeForm.tsx
     ProgressBar.tsx
     FormField.tsx (共通コンポーネント)
   ```

2. **カスタムフックの導入**
   ```typescript
   // hooks/useOnboardingForm.ts
   export const useOnboardingForm = () => {
     // フォーム状態管理ロジック
   }
   ```

3. **型定義の外部化**
   ```typescript
   // types/onboarding.ts
   export interface BusinessInfo { ... }
   export interface SNSAISettings { ... }
   ```

4. **フォームライブラリの導入**
   - react-hook-formやformikの導入を検討
   - バリデーションの一元管理

5. **定数の外部化**
   ```typescript
   // constants/onboarding.ts
   export const INDUSTRY_OPTIONS = [...]
   export const COMPANY_SIZE_OPTIONS = [...]
   ```

## パフォーマンス

- ⚠️ ファイルサイズが大きく、初期ロードに影響する可能性
- ⚠️ 状態変数が多数あり、再レンダリングが発生しやすい
- ✅ 必要時のみデータを読み込む設計

## セキュリティ

- ✅ 認証チェック（未認証ユーザーはログインページへリダイレクト）
- ✅ パスワード変更時のバリデーション
- ✅ ユーザーIDでデータをフィルタリング

## 依存関係

- `firebase/firestore` - Firestore操作
- `next/navigation` - Next.jsルーティング
- `lucide-react` - アイコン
- `../../utils/authFetch` - 認証付きHTTPリクエスト
- `../../lib/ui/notifications` - 通知システム

## まとめ

オンボーディングページは、機能としては充実していますが、ファイルサイズが非常に大きく（1680行）、保守性とテスタビリティに課題があります。主な改善点は、コンポーネント分割、状態管理の整理、コードのリファクタリングです。特に、各ステップを独立したコンポーネントに分割することで、コードの可読性と保守性が大幅に向上します。

