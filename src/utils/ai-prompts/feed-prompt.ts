import { UserProfile } from "../../types/user";
import { buildSystemPrompt } from "./base-prompt";

/**
 * ãƒ•ã‚£ãƒ¼ãƒ‰æŠ•ç¨¿ç”Ÿæˆç”¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ(2026å¹´ç‰ˆ)
 * ä¼æ¥­å‘ã‘ã®æŠ•ç¨¿æ§‹é€ ã‚’ç”Ÿæˆ
 */
export const buildFeedPrompt = (
  userProfile: UserProfile,
  snsType: string,
  contentTypes?: string[],
  contentTypeOther?: string
): string => {
  const basePrompt = buildSystemPrompt(userProfile, snsType);
  const { businessInfo } = userProfile;

  // å•†å“æƒ…å ±ã®è‡ªç„¶ãªç¹”ã‚Šè¾¼ã¿æ–¹(è©°ã‚è¾¼ã¿ã‚’é˜²ã)
  const productGuidance = businessInfo.productsOrServices && businessInfo.productsOrServices.length > 0
    ? `
ã€å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã€‘
${businessInfo.productsOrServices.map((p, index) => {
  let info = `${index + 1}. ${p.name}`;
  if (p.details) info += ` - ${p.details}`;
  if (p.price) info += ` (${p.price}å††)`;
  return info;
}).join("\n")}

**é‡è¦ãªåˆ¶ç´„**:
- 1æŠ•ç¨¿ã«ã¤ã**1ã¤ã®å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿**ã‚’è‡ªç„¶ã«è¨€åŠ
- å•†å“åã‚’å‡ºã™ã®ã¯æŠ•ç¨¿ã®**å¾ŒåŠ(100æ–‡å­—ä»¥é™)**
- ä¾¡æ ¼ã¯ã€Œå®£ä¼ã€ã«ãªã‚‰ãªã„æ–‡è„ˆã§ã®ã¿è¨€åŠ(ä¾‹:ã€Œæ„å¤–ã¨ã€‡ã€‡å††ã§å§‹ã‚ã‚‰ã‚Œã‚‹ã€)
- **ä»Šå›ç”Ÿæˆã—ãŸå•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹åã¯ã€æ¬¡ã®ç”Ÿæˆæ™‚ã«ã¯ä½¿ç”¨ã—ãªã„**ï¼ˆãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¾¹åº•ï¼‰
`
    : "";

  const feedInstructions = `
ã€âš ï¸ çµ¶å¯¾éµå®ˆ:æ–‡å­—æ•°åˆ¶é™ã€‘
- **150æ–‡å­—ä»¥ä¸Š200æ–‡å­—ä»¥å†…**(å³å®ˆ)

ã€ã‚ãªãŸã®å½¹å‰²ã€‘
ã‚ãªãŸã¯${businessInfo.industry || "ãƒ“ã‚¸ãƒã‚¹"}æ¥­ç•Œã®å°‚é–€å®¶ã¨ã—ã¦ã€Instagramãƒ•ã‚£ãƒ¼ãƒ‰æŠ•ç¨¿ã«æœ€é©ãªæŠ•ç¨¿æ–‡ã‚’ææ¡ˆã™ã‚‹instagramãƒ•ã‚£ãƒ¼ãƒ‰æŠ•ç¨¿å°‚é–€å®¶ã§ã™ã€‚

## æŠ•ç¨¿ã®æ§‹é€ (å¿…ãšå®ˆã‚‹)

### 1. ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå†’é ­ï¼‰
- **ã‚¿ã‚¤ãƒˆãƒ«å½¢å¼**: ã€Œã€‡ã€‡ã§ã€‡ã€‡ã‚’å®Ÿç¾ã€ã€Œã€‡ã€‡ã®ã‚³ãƒ„ã¨æ³¨æ„ç‚¹ã€ãªã©
- ã¾ãŸã¯**ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«**: ã€ŒğŸ¤ ã€‡ã€‡ä¼ç”»ã®ã‚³ãƒ„ã¨æ³¨æ„ç‚¹ã€ãªã©
- âŒ **çµ¶å¯¾NG**: ã€Œï¼¼ã€ã€Œï¼ã€ãªã©ã®è£…é£¾è¨˜å·ã¯ä½¿ç”¨ã—ãªã„

### 2. æŒ¨æ‹¶ï¼ˆç°¡æ½”ã«ï¼‰
- ã€Œã“ã‚“ã«ã¡ã¯ã€${userProfile.name}ã§ã™ã€ãªã©ã€ç°¡æ½”ãªæŒ¨æ‹¶
- âŒ **çµ¶å¯¾NG**: ã€Œãƒ•ã‚©ãƒ­ãƒ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ã€Œã„ã„ã­ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ã€Œã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ãªã©ã®è¿”ä¿¡å½¢å¼ã®æŒ¨æ‹¶ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„

### 3. å°å…¥ï¼ˆèª­è€…ã®å¿ƒç†çŠ¶æ…‹ã«å…±æ„Ÿï¼‰
- èª­è€…ã®èª²é¡Œã‚„æ‚©ã¿ã«å…±æ„Ÿã™ã‚‹å†…å®¹
- ä¾‹: ã€Œã€‡ã€‡é‹ç”¨ã§æ–°ã—ã„å±¤ã«ãƒªãƒ¼ãƒã—ãŸã„ãªã‚‰ã€ã€‡ã€‡ã¯éå¸¸ã«åŠ¹æœçš„ã§ã™ã€‚ãŸã ã—ã€Œèª°ã¨ãƒ»ã©ã†çµ„ã‚€ã‹ã€ã§æˆæœã¯å¤§ããå¤‰ã‚ã‚Šã¾ã™ã€‚ã€

### 4. ç®‡æ¡æ›¸ãã§æƒ…å ±ã‚’æ•´ç†
- ã€Œâ‘  ã€‡ã€‡ã€ã€Œâ‘¡ ã€‡ã€‡ã€ãªã©ã€ç®‡æ¡æ›¸ãã‚’ä½¿ç”¨ã—ã¦æƒ…å ±ã‚’æ•´ç†
- è£…é£¾è¨˜å·(â”ã€\\ã€/)ã¯ä½¿ç”¨å¯

### 5. ã¾ã¨ã‚
- æŠ•ç¨¿ã®æ ¸å¿ƒã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã‚‹

### 6. CTAï¼ˆèª­è€…ã®å¿ƒç†çŠ¶æ…‹ã«æ²¿ã£ãŸè¡Œå‹•å–šèµ·ï¼‰
- èª­è€…ã®æ‚©ã¿ã‚„èª²é¡Œã«æ²¿ã£ãŸCTA
- ä¾‹: ã€ŒğŸ“©ã€Œã€‡ã€‡ã§ãŠæ‚©ã¿ã®æ–¹ã¯ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‹ã‚‰ç„¡æ–™è¨ºæ–­ã‚’ãƒã‚§ãƒƒã‚¯ï¼ã€ã€

### 7. å›ºå®šåŒ–ã•ã‚ŒãŸæ–‡æœ«ï¼ˆè‡ªå‹•ä»˜ä¸ï¼‰
- ä¼šç¤¾æƒ…å ±ã€URLã€ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯è‡ªå‹•çš„ã«ä»˜ä¸ã•ã‚Œã¾ã™

${productGuidance}

${(() => {
  if (!contentTypes || contentTypes.length === 0) return "";
  
  const contentTypeLabels: Record<string, string> = {
    product: "å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®ç´¹ä»‹",
    testimonial: "ãŠå®¢æ§˜ã®å£°",
    staff: "ã‚¹ã‚¿ãƒƒãƒ•ã®æ—¥å¸¸",
    knowledge: "è±†çŸ¥è­˜ãƒ»ãƒã‚¦ãƒã‚¦",
    event: "ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³æƒ…å ±",
    beforeafter: "ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼",
    behind: "èˆå°è£ãƒ»åˆ¶ä½œéç¨‹",
    other: "ãã®ä»–",
  };
  
  const contentTypeDescriptions: Record<string, string> = {
    product: "å•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®é­…åŠ›ã€ç‰¹å¾´ã€ä½¿ã„æ–¹ã‚’ä½“é¨“è«‡ã¨å…±ã«ç´¹ä»‹ã€‚å®£ä¼ã§ã¯ãªãã€Œä½¿ã£ã¦ã¿ãŸæ„Ÿæƒ³ã€ã¨ã—ã¦è‡ªç„¶ã«èªã‚‹",
    testimonial: "ãŠå®¢æ§˜ã‹ã‚‰ã®å®Ÿéš›ã®å£°ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å†ç¾ã€‚ä¼šè©±å½¢å¼ã‚„å¼•ç”¨ã‚’ä½¿ã„ã€ãƒªã‚¢ãƒ«ãªä½“é¨“ã‚’å…±æœ‰",
    staff: "ã‚¹ã‚¿ãƒƒãƒ•ã®æ—¥å¸¸æ¥­å‹™ã‚„ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã€‚å¿™ã—ã„ç¾å ´ã®ãƒªã‚¢ãƒ«ã‚„ã€å°ã•ãªç™ºè¦‹ã‚’è¦ªã—ã¿ã‚„ã™ãèªã‚‹",
    knowledge: "æ¥­ç•Œã®è±†çŸ¥è­˜ã‚„ãƒã‚¦ãƒã‚¦ã‚’å…±æœ‰ã€‚å°‚é–€çŸ¥è­˜ã‚’å™›ã¿ç •ã„ã¦ã€ã‚ã‹ã‚Šã‚„ã™ãèª¬æ˜",
    event: "ã‚¤ãƒ™ãƒ³ãƒˆã‚„ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®æƒ…å ±ã€‚é–‹å‚¬ã®èƒŒæ™¯ã‚„ã€å‚åŠ è€…ã®åå¿œã‚’ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¨ã—ã¦èªã‚‹",
    beforeafter: "ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼ã®å¤‰åŒ–ã‚’ç‰©èªã¨ã—ã¦ã€‚å¤‰åŒ–ã®éç¨‹ã‚„ã€ãã®æ™‚ã®æ„Ÿæƒ…ã‚’å…·ä½“çš„ã«æå†™",
    behind: "åˆ¶ä½œéç¨‹ã‚„èˆå°è£ã‚’å…¬é–‹ã€‚å¤±æ•—è«‡ã‚„è©¦è¡ŒéŒ¯èª¤ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã‚’ã€ãƒªã‚¢ãƒ«ã«å†ç¾",
    other: contentTypeOther || "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸå†…å®¹",
  };
  
  const contentTypesText = contentTypes
    .map((type) => contentTypeLabels[type] || type)
    .join("ã€") + (contentTypeOther ? `ï¼ˆ${contentTypeOther}ï¼‰` : "");
  
  const selectedTypes = contentTypes.length === 1 
    ? contentTypes[0] 
    : null;
  
  if (selectedTypes) {
    const description = contentTypeDescriptions[selectedTypes] || "";
    return `
## ğŸ“ æŠ•ç¨¿å†…å®¹ã®æ–¹å‘æ€§

**ä»Šå›ã®æŠ•ç¨¿ã¯ã€Œ${contentTypeLabels[selectedTypes]}ã€ã®æ–¹å‘æ€§ã§ä½œæˆã—ã¦ãã ã•ã„ã€‚**

${description}

**é‡è¦ãªæŒ‡ç¤º**:
- ã“ã®æ–¹å‘æ€§ã«æ²¿ã£ãŸå†…å®¹ã§ã€ä¸Šè¨˜ã®æ§‹é€ ï¼ˆã‚¿ã‚¤ãƒˆãƒ«â†’æŒ¨æ‹¶â†’å°å…¥â†’ç®‡æ¡æ›¸ãâ†’ã¾ã¨ã‚â†’CTAï¼‰ã‚’å®ˆã£ã¦æŠ•ç¨¿ã‚’ç”Ÿæˆ
- æ–¹å‘æ€§ã«åˆã‚ãªã„å†…å®¹ã¯é¿ã‘ã‚‹
`;
  } else {
    return `
## ğŸ“ æŠ•ç¨¿å†…å®¹ã®æ–¹å‘æ€§

**è¨ˆç”»ã§æŒ‡å®šã•ã‚ŒãŸæŠ•ç¨¿å†…å®¹ã®ç¨®é¡: ${contentTypesText}**

ä»¥ä¸‹ã®æ–¹å‘æ€§ã‹ã‚‰**1ã¤ã‚’é¸ã‚“ã§**ã€ãã®æ–¹å‘æ€§ã«æ²¿ã£ãŸæŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„:

${contentTypes.map((type, index) => {
  const label = contentTypeLabels[type] || type;
  const description = contentTypeDescriptions[type] || "";
  return `${index + 1}. **${label}**: ${description}`;
}).join("\n\n")}

**é‡è¦ãªæŒ‡ç¤º**:
- ä¸Šè¨˜ã®æ–¹å‘æ€§ã‹ã‚‰**1ã¤ã‚’é¸ã‚“ã§**ã€ãã®æ–¹å‘æ€§ã«æ²¿ã£ãŸå†…å®¹ã§æŠ•ç¨¿ã‚’ç”Ÿæˆ
- é¸ã‚“ã æ–¹å‘æ€§ã«æ²¿ã£ã¦ã€ä¸Šè¨˜ã®æ§‹é€ ï¼ˆã‚¿ã‚¤ãƒˆãƒ«â†’æŒ¨æ‹¶â†’å°å…¥â†’ç®‡æ¡æ›¸ãâ†’ã¾ã¨ã‚â†’CTAï¼‰ã‚’å®ˆã‚‹
- æ¬¡å›ã®æŠ•ç¨¿ã§ã¯**åˆ¥ã®æ–¹å‘æ€§**ã‚’é¸ã‚“ã§ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒãŸã›ã‚‹
- æ–¹å‘æ€§ã«åˆã‚ãªã„å†…å®¹ã¯é¿ã‘ã‚‹
`;
  }
})()}

`;

  return basePrompt + feedInstructions;
};
